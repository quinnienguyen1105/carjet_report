<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="copyright" content="Copyright (c) 2022 UI Group 4">
    <meta name="author" content="Group 4">
    <meta name="keywords"
        content="html5, semantic tags, CSS3, responsive layout, JS, JS+DOM, JS events, Bootstrap, mobile first">
    <meta name="description" content="Index page for UI project IWD2 Fanshawe course Fall 2022">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link
        href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;700&family=Dancing+Script:wght@400;700&family=Markazi+Text&family=Sacramento&family=Tangerine:wght@400;700&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="./project2.css">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous">
        </script>
    <script src="https://kit.fontawesome.com/ec6430f550.js" crossorigin="anonymous"></script>

    <script src="./lib/d3.v7.min.js" charset="utf-8"></script>
    <title>CanJet Customer Satisfication Report</title>
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-light">
            <div class="container-fluid">
                <span class="navbar-brand" href="#"><img src="./logo.png" alt="company logo"> CanJet Customer
                    Satisfication Report</span>

                <!-- <button type="button" id="sidebarCollapse">
                    <span class="navbar-toggler-icon"></span>
                </button> -->
            </div>
        </nav>
    </header>





    <!-- SELECT PAGE-- PLEASE DO NOT TOUCH THE DIV, ONLY EDIT CONTENT INSIDE-->
    <div id="dashboardContainer">


        <div class="container">
            <h1 class="textHeading1">Dashboard<h1></h1>
                <div class="row">
                    <div class="col-xs-12 col-md-6 col-lg-4">
                        <p class="chart-title" style="color:#d73038">Number of Loyal customers</p>

                        <div id="chart7"></div>
                    </div>
                    <div class="col-xs-12 col-md-6 col-lg-4">
                        <p class="chart-title" style="color:#d73038">Total Number of flight distance</p>

                        <div id="chart8"></div>
                    </div>
                    <div class="col-xs-12 col-md-6 col-lg-4">
                        <p class="chart-title" style="color:#d73038">Number of customers have never delayed</p>

                        <div id="chart9"></div>
                    </div>
                </div>
                <div class="clear"></div>
                <div class="row">
                    <div class="col-xs-12 col-lg-12">
                        <p class="chart-title" style="color:#d73038">Distance travelled by each customer</p>
                        <p class="textBody" style="font-size: smaller;">(Try hovering to the dots!)</p>

                        <div id="chart1"></div>
                    </div>
                </div>
                <div class="clear"></div>
                <div class="row">
                    <div class="col-xs-12 col-md-6 col-lg-6">
                        <p class="chart-title" style="color:#d73038">The proportion of satisfied/neutral or unsatisfied
                            customer </p>
                        <p class="textBody" style="font-size: smaller;">(Try hovering to the legends!)</p>

                        <div id="chart2"></div>
                    </div>
                    <div class="col-xs-12 col-md-6 col-lg-6">
                        <p class="chart-title" style="color:#d73038">Number of Satisfactory levels by category</p>
                        <div id="chart3dd" class="select"></div>
                        <div id="chart3Icons">
                            <ul>
                                <li style="list-style: none !important"><img src="images/icons/checkin.png"
                                        class="c3Icon" onclick="switchCharts('Checkin service')"></li>
                                <li style="list-style: none !important"><img src="images/icons/online.png"
                                        class="c3Icon" onclick="switchCharts('Ease of Online booking')"></li>
                                <li style="list-style: none !important"><img src="images/icons/gate.png" class="c3Icon"
                                        onclick="switchCharts('Gate location')"></li>
                                <li style="list-style: none !important"><img src="images/icons/onboard.png"
                                        class="c3Icon" onclick="switchCharts('On-board service')"></li>
                                <li style="list-style: none !important"><img src="images/icons/baggage.png"
                                        class="c3Icon" onclick="switchCharts('Baggage handling')"></li>
                            </ul>
                            <div class="clear"></div>
                        </div>
                        <div id="chart3"></div>
                    </div>
                </div>
                <div class="clear"></div>
                <div class="row">
                    <div class="col-xs-12 col-md-6 col-lg-6" id="chart5">
                        <p class="chart-title" style="color:#d73038">Average Satisfaction rate by Seat Class</p>

                        <!-- <div class="containerC5"> -->
                        <button id="buttonC5" onclick="tableToggle()"><span id="buttonText" class="textChart">Change
                                Chart</span> <i id='iconToggle' class="fa-solid fa-toggle-on icon"></i></button>

                        <div id="barChart"></div>
                        <div id="lineChart"></div>
                        <!-- </div> -->
                    </div>
                    <div class="col-xs-12 col-md-6 col-lg-6">
                        <p class="chart-title" style="color:#d73038">Total Departure and Arrival Delay in Minutes</p>
                        <p class="textBody" style="font-size: smaller;">(Try brushing!)</p>

                        <div id="chart4"></div>

                    </div>
                </div>
                <div class="clear"></div>
                <div class="row">
                    <div class="col-xs-12 col-lg-12 svg1">
                        <p class="chart-title" style="color:#d73038">15 Most Disloyal Customers’ 3 Ticket
                            Prices </p>
                        <p class="textBody" style="font-size: smaller;">(Try zooming!)</p>

                        <div id="chart6"></div>
                    </div>

                </div>
        </div>


    </div>









    </div>

    </div>



    </div>
    <script src="lib/d3-d3-37b1960/src/index.js"></script>
    <script type="text/javascript">

        //[Chart1]

        //Set the dimensions and margins of the graph
        var svgWidthC1 = 1000,
            svgHeightC1 = 400;
        var marginC1 = {
            top: 30,
            right: 20,
            bottom: 30,
            left: 70
        },
            widthC1 = svgWidthC1 - marginC1.left - marginC1.right,
            heightC1 = svgHeightC1 - marginC1.top - marginC1.bottom;


        var svgC1 = d3.select("#chart1")
            .append("svg")
            // .attr("width", svgWidthC1)
            // .attr("height", svgHeightC1);
            .attr('viewBox', '0 0 1000 400')
        //.attr('viewBox', '0 0 ' + Math.min(widthC1, heightC1) + ' ' + Math.min(widthC1, heightC1))



        var chartGroupC1 = svgC1.append("g")
            .attr("transform", `translate(${marginC1.left}, ${marginC1.top})`);

        d3.csv("./data/customer_satisfaction.csv").then(function (customerData) {

            customerData.forEach(function (data) {
                data.id = +data.id;
                data.Flight_Distance = +data.Flight_Distance;
            });

            var xLinearScale = d3.scaleLinear()
                .domain([0, d3.max(customerData, d => d.id)])
                .range([0, widthC1]);

            var yLinearScale = d3.scaleLinear()
                .domain([0, d3.max(customerData, d => d.Flight_Distance)])
                .range([heightC1, 0]);

            var bottomAxis = d3.axisBottom(xLinearScale);
            var leftAxis = d3.axisLeft(yLinearScale);

            chartGroupC1.append("g")
                .attr("transform", `translate(0, ${heightC1})`)
                .call(bottomAxis);

            chartGroupC1.append("g")
                .call(leftAxis);

            var line = d3.line()
                .x(d => xLinearScale(d.id))
                .y(d => yLinearScale(d.Flight_Distance));

            chartGroupC1.append("path")

                .attr("fill", "none")
                .attr("stroke", "#EC9A29")
                .attr("stroke-width", 4)
                .attr("d", line(customerData));

            chartGroupC1.selectAll("circle")
                .data(customerData)
                .enter()
                .append("circle")
                .attr("cx", d => xLinearScale(d.id))
                .attr("cy", d => yLinearScale(d.Flight_Distance))
                .attr("r", "5")
                .attr("fill", "#106184")
                .attr("opacity", ".5");


            //show the value of the data point when the mouse is over the data point
            chartGroupC1.selectAll("circle")
                .on("mouseover", function () {
                    //show the value of the ID and Flight_Distance when the mouse is over the data point
                    d3.select(this)
                        .transition()
                        .duration(1000)
                        .attr("r", 15)
                        .attr("fill", "#A76A23")
                        .attr("opacity", ".5");

                    // Create a function to show the value of the data point on the top of the data point whenever the mouse is over the data point.
                    function showToolTip(d) {
                        return `ID: ${d.id}  Flight_Distance: ${d.Flight_Distance} km`;
                    }
                    //Show only the value of the data point when the mouse is over the data point
                    d3.select(this)
                        .append("title")
                        .text(showToolTip);
                })

                //when the mouse is out of the data point, the value will disappear
                .on("mouseout", function () {
                    d3.select(this)
                        .transition()
                        .duration(1000)
                        .attr("r", 5)
                        .attr("fill", "#821214")
                        .attr("opacity", ".5");
                });

            chartGroupC1.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - marginC1.left)
                .attr("x", 0 - (heightC1 / 1.5))
                .attr("dy", "1em")
                .attr("class", "naming")
                // .style("font", "14px sans-serif")
                .text("Flight Distance (km)")
            // .attr("fill", "orange");

            chartGroupC1.append("text")
                .attr("transform", `translate(${widthC1 / 2.2}, ${heightC1 + marginC1.top})`)
                .attr("class", "naming")
                .text("Customer ID")
            // .style("font", "14px sans-serif")
            // .attr("fill", "red");

            //     svgC1.append("text")
            //     .attr("class", "chart-title")
            //     .attr("x", 0)
            //     .attr("y", 0 - (marginC1.top / 2))
            //     // .attr("font-size", "14px")
            //     // .attr("font-family", "Arial")
            //     // .attr("font-weight", "bold")
            //     // .attr("font-style", "italic")
            //     .text("Distance travelled by each customer")
            //    // .attr("fill", "black");

        }).catch(function (error) {
            console.log(error);
        });








        //【Chart2】


        //Get the data from the CSV file
        d3.csv("./data/customer_satisfaction.csv").then((data) => {
            var width, height, radius;
            var percentages = [];
            var totalSatisfied = data.filter(x => x.satisfaction === "satisfied").length;
            var totalNeutralOrDissatisfied = data.filter(x => x.satisfaction === "neutral or dissatisfied").length;
            var total = totalSatisfied + totalNeutralOrDissatisfied;

            percentages.push(totalSatisfied / total, totalNeutralOrDissatisfied / total);

            width = 400;
            height = 400;
            radius = Math.min(width, height) / 2;

            //Colorize the pie chart
            var color = d3.scaleOrdinal()
                .domain(d3.range(percentages.length))
                .range(["#EC9A29", "#477CB2"]);

            var arc = d3.arc().innerRadius(radius * 0.6).outerRadius(radius * 0.99);

            var pie = d3.pie()
                .value((d) => d)
                .sort(null);

            var svgC2 = d3.select('#chart2').append('svg')
                // .attr('width', '100%')
                // .attr('height', '100%')
                .attr('viewBox', '0 0 500 500')
                .append('g')
                // .attr('transform', 'translate(' + Math.min(width, height) / 2 + ',' + Math.min(width, height) / 2 + ')')
                .attr('transform', 'translate(250,250)')
            var path = svgC2.selectAll('path')
                .data(pie(percentages))
                .enter()
                .append('path')
                .attr('fill', (d, i) => color(i))
                .attr('d', arc);

            var legendRectSize = 15;
            var legendSpacing = 4;

            var legend = svgC2.selectAll('.legend')
                .data(color.domain())
                .enter()
                .append('g')
                .attr('class', 'legend')
                .style("font", "12px sans-serif")
                .attr('transform', (d, i) => {
                    var height = legendRectSize + legendSpacing;
                    var offset = height * color.domain().length / 2;
                    var horz = -2 * legendRectSize;
                    var vert = i * height - offset;
                    return 'translate(' + horz + ',' + vert + ')';
                });

            legend.append('rect')
                .attr('width', legendRectSize)
                .attr('height', legendRectSize)
                .attr('fill', color)
                .attr('stroke', color);

            legend.append('text')
                .attr('x', legendRectSize + legendSpacing)
                .attr('y', legendRectSize - legendSpacing)
                .text((d, i) => {
                    if (i === 0) {
                        return "Satisfied";
                    } else {
                        return "Neutral or Dissatisfied";
                    }
                })
            //.text((d) => { return percentages[d]; });
            // When the mouse is over the legend, the percentage of the pie chart is displayed.
            legend.on('mouseover', function (d, i) {
                var percentage = percentages[i];
                var percentageText = "";
                if (i === 0) {
                    percentageText = "Satisfied: " + percentage.toFixed(2) * 100 + "%";
                    svgC2.append("text")
                        .attr("class", "percentage")
                        .attr("x", 0)
                        .attr("y", 0)
                        .attr("text-anchor", "middle")
                        .attr("dy", "3em")
                        .attr("alignment-baseline", "under")
                        .attr("dominant-baseline", "middle")
                        .attr("font-size", "14px")
                        .attr("font-family", "Arial")
                        .attr("font-weight", "bold")
                        .attr("font-style", "italic")
                        .attr("fill", "#EC9A29")
                        .text(percentageText);
                } else {
                    percentageText = "Neutral or Dissatisfied: " + percentage.toFixed(2) * 100 + "%";
                    svgC2.append("text")
                        .attr("class", "percentage")
                        .attr("x", 0)
                        .attr("y", 0)
                        .attr("text-anchor", "middle")
                        .attr("dy", "3em")
                        .attr("alignment-baseline", "under")
                        .attr("dominant-baseline", "middle")
                        .attr("font-size", "14px")
                        .attr("font-family", "Arial")
                        .attr("font-weight", "bold")
                        .attr("font-style", "italic")
                        .attr("fill", "#477CB2")
                        .text(percentageText);
                }
            });
            // When the mouse is out of the legend, the percentage of the pie chart is removed.
            legend.on('mouseout', function (d, i) {
                svgC2.select(".percentage").remove();

            });

            //add title
            // svgC2.append("text")
            //     .attr("x", 0)
            //     .attr("y", 10)
            //     // .attr("text-anchor", "middle")
            //     // .attr("dy", "-5em")
            //     // .attr("font-size", "14px")
            //     // .attr("font-family", "Arial")
            //     // .attr("font-weight", "bold")
            //     // .attr("font-style", "italic")
            //     // .attr("fill", "black")
            //     .text("Distance travelled by each customer")
            //     .attr("class","chart-title");

        });
        // End of pie chart


        //【 Chart 3 】
        var colorsC3 = ["#106184", "#477CB2", "#EC9A29", "#A76A23", "#821214"]
        // Make the dropdown
        var categoryGroup = ["Checkin service", "Ease of Online booking", "Gate location", "On-board service", "Baggage handling"];



        var dropdown = d3.select("#chart3dd")
            .append('select');

        dropdown.selectAll('option')
            .data(categoryGroup)
            .enter()
            .append('option')
            .text(function (d) {
                return d;
            })
            .attr('value', function (d) {
                return d;
            });
        // Dropdown onChange
        dropdown.on('change', function (d) {
            var selectedCategory = d3.select(this).property("value");
            switchCharts(selectedCategory)

        })
        // Chart 3 Canvas
        var svgC3Width = 500;
        var svgC3Height = 500;
        var c3Padding = 100;

        var svgChart3 = d3.select("#chart3")
            .append("svg")
            // .attr("width", svgC3Width)
            // .attr("height", svgC3Height)
            .attr('viewBox', '0 0 500 500')

        var c3_inner_width = svgC3Width - c3Padding;
        var c3_inner_height = svgC3Height - c3Padding;

        var c3_g = svgChart3.append('g')
            .attr('class', 'group')
            .attr("transform", "translate(50, 50)")

        // X & Y axis
        var xscaleC3 = d3.scaleBand()
            .range([0, c3_inner_width])
            .paddingInner(0.5)
            .paddingOuter(0.2)

        var yscaleC3 = d3.scaleLinear()
            .range([c3_inner_height, 0])

        // calling the X axis and making legend
        xscaleC3.domain([0, 1, 2, 3, 4, 5])
        var xaxisC3 = d3.axisBottom()
            .scale(xscaleC3)
        c3_g.append('g')
            .attr('transform', 'translate(0,' + c3_inner_height + ')')
            .call(xaxisC3)
            .append('text')
            .attr('x', c3_inner_width / 2)
            .attr('y', 40)
            .attr('fill', '#000')
            .text('Rating')

        // calling the Y axis and making legend
        yscaleC3.domain([0, 35])
        var yaxisC3 = d3.axisLeft()
            .scale(yscaleC3)
        c3_g.append('g')
            .call(yaxisC3)
            .append('text')
            .attr('transform', 'rotate(-90)')
            .attr('x', -170)
            .attr('y', -30)
            .attr('fill', '#000')
            .text('Number')



        // Title
        var c3Title = svgChart3.append("text")
            .attr("class", "textChart")
            .attr("id", "subtitleC3")
            .attr("x", 200)
            .attr('y', 30).text("Checkin service") // default option


        // Generate charts basing on derpdown value
        function switchCharts(selectedCategory = "Checkin service") {

            var color = colorsC3[categoryGroup.indexOf(selectedCategory)]

            d3.selectAll('.bar').remove()
            // Change Title
            c3Title.text(selectedCategory);

            // importing data
            d3.csv("./data/customer_satisfaction.csv").then(function (data) {

                data = data.map(d => d[selectedCategory])
                console.log(data);
                d3.count(data, d => d = "4")
                data = Object.entries(countOccurrences(data))
                console.log(data);

                var c3_graph = c3_g.selectAll(".graph")
                    .data(data)
                    .enter()
                    .append('g')



                c3_graph.append("rect")
                    .attr("class", "bar")
                    .attr('x', function (d) { return xscaleC3(parseInt(d[0])) })
                    .attr('y', function (d) { return yscaleC3(d[1]) })
                    .attr('width', xscaleC3.bandwidth())
                    .attr('height', function (d) { return c3_inner_height - yscaleC3(d[1]) })
                    .attr("fill", color);


                c3_graph
                    .append("text")
                    .attr("class", "bar textChart")
                    .attr("x", function (d) {
                        return xscaleC3(parseInt(d[0]));
                    })
                    .attr("y", function (d) {
                        return yscaleC3(d[1])
                    })
                    .attr("dx", "0.4em")
                    .attr("dy", "-0.5em")
                    .text(function (d) {
                        return d[1]
                    })
                    .attr("fill", color);
            })

        }



        function countOccurrences(data) {
            let countObject = data.reduce(function (
                count,
                currentValue
            ) {
                return (
                    count[currentValue] ? ++count[currentValue] : (count[currentValue] = 1),
                    count
                );
            },
                {});
            return countObject;
        }




        //【Chart4】
        // set the dimensions and margins of the graph
        var width = 500, height = 500;
        var margin = { top: 20, right: 40, bottom: 10, left: 40 };

        // append the svg object to the body of the page
        var svgC4 = d3.select("#chart4")
            .append("svg")
            // Make it responsive
            .attr("preserveAspectRatio", "xMinYMin meet")
            .attr("viewBox", "0 0 500 500")
            .classed("svg-content", true)
            // .attr("style", "outline: thin solid #bbb;")
            .append("g")
            .attr("transform",
                "translate(95, 85)");


        d3.csv("./data/customer_satisfaction.csv").then(function (data) {
            var xScale = d3.scaleLinear()
                .domain([0, 6])
                .range([0, width - 75]);

            var yScale = d3.scaleLinear()
                .domain([350, 0])
                .range([0, height - 75]);

            var xLines = svgC4.append("g")
                .attr("transform",
                    "translate(0, " + (height - 75) + ")")
                .attr("class", "naming")
                .call(d3.axisBottom(xScale).ticks(6)
                    .tickSize(-height + 75).tickPadding(15));

            xLines.selectAll(".tick>line").attr("stroke", "#bbb");

            var yLines = svgC4.append("g")
                .style("z-index",
                    -1)
                .attr("class", "naming")
                .call(d3.axisLeft(yScale).ticks(7)
                    .tickSize(-width + 75).tickPadding(15));

            yLines.selectAll(".tick>line").attr("stroke", "#bbb");

            // text label for the x axis
            svgC4.append("text")
                .attr("x", width / 4)
                .attr("y", height - 15)
                .attr("class", "naming")
                .text("Departure/arrival time convenient");

            // text label for the y axis 
            svgC4.append("text")
                .attr("x", -300)
                .attr("y", -60)
                .attr("transform", "rotate(-90)")
                .attr("class", "naming")
                .text("Total Departure and Arrival Delay in Minutes");

            var dots = svgC4.append("g")
                .selectAll("dot").data(data);

            dots.enter().append("circle")
                .attr("cx", function (d) { return xScale(d['Departure/Arrival time convenient']); })
                .attr("cy", function (d) { return yScale(d['Total Departure and Arrival Delay in Minutes']); })
                .attr("class", 'inGraph')
                .attr("r", 4)
                .style("fill", "#ED1C24");

            //create a brush
            const brush = d3.brush().
                extent([[0, 0], [325, 325]])
                .on("start brush", updateChart);

            //add brush to canvas
            const gBrush = svgC4.append('g')
                .attr('class', 'brush')
                .call(brush);

            function updateChart(event) {
                const selection = event.selection;
                console.log(selection);
                d3.selectAll('circle.inGraph').classed("selected_4", function (d) {
                    return isBrushed(selection, xScale(d['Departure/Arrival time convenient']),
                        yScale(d['Total Departure and Arrival Delay in Minutes']))
                })
            }

            // A function that return TRUE or FALSE according if a dot is in the selection or not
            function isBrushed(brush_coords, cx, cy) {
                var x0 = brush_coords[0][0],
                    x1 = brush_coords[1][0],
                    y0 = brush_coords[0][1],
                    y1 = brush_coords[1][1];
                return x0 <= cx && cx <= x1 && y0 <= cy && cy <= y1;    // This return TRUE or FALSE depending on if the points is in the selected area
            }
        });


        //【Chart5】
        let bBarChart = document.getElementById("barChart");
        let lLineChart = document.getElementById("lineChart");
        let buttonClass = document.getElementById('iconToggle');

        function tableToggle() {
            if (lLineChart.style.display === "none") {
                lLineChart.style.display = "block";
                bBarChart.style.display = "none";
                buttonClass.className = 'fa-solid fa-toggle-off icon'
            } else {
                bBarChart.style.display = "block";
                lLineChart.style.display = "none";
                buttonClass.className = 'fa-solid fa-toggle-on icon'
            }
        }
        //BarChart
        let bSvgWidth = 600; // 600 originally - tt
        let bSvgHeight = 600; // 600 originally - tt
        let bPadding = 100;


        let bSvg = d3
            .select("#barChart")
            .append("svg")
            .attr("width", "100%")
            .attr("height", "100%")
            //make the svg responsive according to the size of the window
            // .attr('preserveAspectRatio', 'xMinYMin meet')
            .attr('viewBox', '0 0 600 600')


        // .attr('viewBox', '0 0 500 500') - tt


        // bSvg
        //     .append("text")
        //     .attr("class", "chart-title")
        //     .attr("x", 160)
        //     .attr("y", 40)
        //     .text("Average satisfaction");

        let bInner_width = bSvgWidth - bPadding;
        let bInner_height = bSvgHeight - bPadding;

        let bG = bSvg
            .append("g")
            .attr("class", "group")
            .attr("transform", "translate(75, 0)")

        let bXscale = d3
            .scaleBand()
            .range([0, bInner_width])
            .paddingInner(0.5)
            .paddingOuter(0.4);

        let bYscale = d3.scaleLinear().range([bInner_height, 0]);

        d3.csv("./data/customer_satisfaction.csv").then(function (data) {

            let avgForBusiness = d3.mean(data.filter(n => n['Class'] == 'Business').map(n =>
                n['Average Satisfaction']
            )).toFixed(2);

            let avgForEco = d3.mean(data.filter(n => n['Class'] == 'Eco').map(n =>
                n['Average Satisfaction']
            )).toFixed(2);

            let avgForEcoPlus = d3.mean(data.filter(n => n['Class'] == 'Eco Plus').map(n =>
                n['Average Satisfaction']
            )).toFixed(2);

            // console.log(avgForBusiness);
            // console.log(avgForEco);
            // console.log(avgForEcoPlus);

            data = [
                { name: 'Business', rating: avgForBusiness },
                { name: 'Eco', rating: avgForEco },
                { name: 'Eco Plus', rating: avgForEcoPlus },
            ]


            bXscale.domain(data.map((d) => d.name));

            let bXaxis = d3.axisBottom().scale(bXscale);

            bG.append("g")
                .attr("transform", "translate(0," + bInner_height + ")")
                .call(bXaxis)
                .append("text")
                .attr("class", "naming")
                .attr("x", bInner_width / 2)
                .attr("y", 35)
                .attr("fill", "#000")
                .text("Seat Classes");

            bYscale.domain([0, d3.max(data, (d) => d.rating)]).range([500, 100]);

            let bYaxis = d3.axisLeft().scale(bYscale).ticks(12);

            bG.append("g")
                .call(bYaxis)
                .append("text")
                .attr("class", "naming")
                .attr("transform", "rotate(-90)")
                .attr("x", -250)
                .attr("y", -30)
                .attr("fill", "#000")
                .text("Rating");

            let graph = bG.selectAll(".graph").data(data).enter().append("g");

            graph
                .append("rect")
                .attr("class", "barC5")
                .attr("x", function (d) {
                    return bXscale(d.name);
                })
                .attr("y", function (d) {
                    return bYscale(d.rating);
                })
                .attr("width", bXscale.bandwidth())
                .attr("height", function (d) {
                    return bInner_height - bYscale(d.rating);
                });

            graph
                .append("text")
                .attr("x", function (d) {
                    return bXscale(d.name);
                })
                .attr("y", function (d) {
                    return bYscale(d.rating);
                })
                .attr("dx", "1.4em")
                .attr("dy", "-0.5em")
                .text(function (d) {
                    return d.rating;
                })
                .attr("fill", "#821214")
                .attr("class", "textChart")
        });
        //EndBarChart

        //LineChart
        let lSvgWidth = 600;
        let lSvgHeight = 600;
        let lPadding = 100;

        let lSvg = d3
            .select("#lineChart")
            .append("svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr('viewBox', '0 0 600 600')

        // lSvg
        //     .append("text")
        //     .attr("class", "chart-title")
        //     .attr("x", 160)
        //     .attr("y", 40)
        //     .text("Average satisfaction");

        let lInner_width = lSvgWidth - lPadding;
        let lInner_height = lSvgHeight - lPadding;

        let lG = lSvg
            .append("g")
            .attr("transform", "translate(75, 0)")
            .attr("class", "graph");

        let lXscale = d3
            .scaleBand()
            .range([0, lInner_width])
            .paddingInner(1)
            .paddingOuter(0.4);

        let lYscale = d3.scaleLinear().range([lInner_height, 0]);

        d3.csv("./data/customer_satisfaction.csv").then(function (data) {

            let avgForBusiness = d3.mean(data.filter(n => n['Class'] == 'Business').map(n =>
                n['Average Satisfaction']
            )).toFixed(2);

            let avgForEco = d3.mean(data.filter(n => n['Class'] == 'Eco').map(n =>
                n['Average Satisfaction']
            )).toFixed(2);

            let avgForEcoPlus = d3.mean(data.filter(n => n['Class'] == 'Eco Plus').map(n =>
                n['Average Satisfaction']
            )).toFixed(2);

            // console.log(avgForBusiness);
            // console.log(avgForEco);
            // console.log(avgForEcoPlus);

            data = [
                { name: 'Business', rating: avgForBusiness },
                { name: 'Eco', rating: avgForEco },
                { name: 'Eco Plus', rating: avgForEcoPlus },
            ]
            lXscale.domain(data.map((d) => d.name));

            let lXaxis = d3.axisBottom().scale(lXscale);

            lG.append("g")
                .attr("transform", "translate(0," + lInner_height + ")")
                .call(lXaxis)
                .append("text")
                .attr("class", "naming")
                .attr("x", lInner_width / 2)
                .attr("y", 35)
                .attr("fill", "#000")
                .text("Seat Classes");

            lYscale.domain([0, d3.max(data, (d) => d.rating)]).range([500, 100]);
            // lYscale.domain(d3.extent(data, function(d){
            //         return d.rating
            //     }))

            let lYaxis = d3.axisLeft().scale(lYscale).ticks(20);

            lG.append("g").call(lYaxis);

            let generateLine = d3.line();

            lG.append("g")
                .call(lYaxis)
                .append("text")
                .attr("class", "naming")
                .attr("transform", "rotate(-90)")
                .attr("x", -250)
                .attr("y", -30)
                .attr("fill", "#000")
                .text("Rating");

            lG.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "#ec9a29")
                .attr("stroke-width", 2)
                .attr(
                    "d",
                    generateLine
                        .x(function (d) {
                            return lXscale(d.name);
                        })
                        .y(function (d) {
                            return lYscale(d.rating);
                        })
                );

            let circle = lG.append("g");

            circle
                .selectAll("circle")
                .data(data)
                .enter()
                .append("g")
                .attr("class", "circles")
                .append("circle")
                .attr("cx", function (d) {
                    return lXscale(d.name);
                })
                .attr("cy", function (d) {
                    return lYscale(d.rating);
                })
                .attr("r", 3)
                .attr("fill", "#821214")
                .attr("stroke", "none");

            circle
                .selectAll(".circles")
                .append("text")
                .attr("x", function (d) {
                    return lXscale(d.name) - 5;
                })
                .attr("y", function (d) {
                    return lYscale(d.rating) - 5;
                })
                .text(function (d) {
                    return d.rating;
                })
                .attr("fill", "#A76A23")
                .attr("class", "textChart");
        });
        //EndLineChart








        //【Chart6】
        var svgwidth = 1000;
        var svgheight = 500;
        var padding = 100;

        var svg = d3.select("#chart6")
            .append('svg')
            // .attr('width', svgwidth)
            // .attr('height', svgheight);
            .attr("viewBox", "0 0 1000 500")
        //  .attr("preserveAspectRatio", "xMidYMid")


        // Add title
        // svg.append("text")
        //     .attr("class", "chart-title")
        //     .attr("x", 300)
        //     .attr("y", 40)
        //     .text("The First 15 Disloyal Customers Ticket Prices");

        var inner_width = svgwidth - padding;
        var inner_height = svgheight - padding;

        var g = svg.append("g")
            .attr("transform", "translate(50, 50)")
            .attr("class", "graph");

        var xscale = d3.scalePoint() //tt
            .range([0, inner_width]);
        var yscale = d3.scaleLinear()
            .range([0, inner_height]);

        d3.csv('./data/customer_satisfaction.csv').then(function (data) {

            let a = data.filter(d => d['Customer Type'] == 'disloyal Customer').slice(0, 15)

            data = a.map(d => {
                return {
                    id: d.id,
                    "firstTicket": Number(d["1st Ticket Price"]) || 0,
                    "secondTicket": Number(d["2nd Ticket Price"]) || 0,
                    "thirdTicket": Number(d["3rd Ticket Price"]) || 0,
                };
            });

            data.forEach(function (d) {
                //d.index = parseInt(d.index);
                d.id = parseInt(d.id);
                d.firstTicket = parseFloat(d.firstTicket).toFixed(2)
                d.secondTicket = parseFloat(d.secondTicket).toFixed(2)
                d.thirdTicket = parseFloat(d.thirdTicket).toFixed(2)
            })

            let idRange = data.map(d => d.id) //tt
            console.log(idRange); //tt

            // create xasis
            var xscale = d3.scaleBand()
                            .domain(idRange)
                            .range([0, inner_width])
                            .padding([0.5])

            var xaxis = d3.axisBottom()
                .scale(xscale)
                
            // .tickValues(idRange)

            var createXasis = g.append('g')
                .attr('transform', 'translate(0,' + inner_height + ')')
                .call(xaxis)
            
            // name of xaxis
            g.append("text")
                .attr("class", "naming")
                .attr("x", 400)
                .attr("y", 415)
                .text("Customer ID")
                .attr('transform', 'translate(0,15)');;

            //create yaxis
            yscale.domain([0, d3.max(data, function (d) {
                var AllTicket = parseFloat(d.firstTicket) + parseFloat(d.secondTicket) + parseFloat(d.thirdTicket);
                return parseFloat(AllTicket)+150;
            })])
                .range([inner_height, 0])
            var yaxis = d3.axisLeft()
                .scale(yscale)

            var createYaxis = g.append('g')
                .call(yaxis);
            
            // name of yaxis
            g.append("text")
                .attr("class", "naming")
                .attr("x", -200)
                .attr("y", -40)
                .attr("transform", "rotate(-90)")
                .text("Ticket Price");

            var clip = svg.append('clipPath')
                .attr('id', 'clip')
                .append('rect')
                .attr('width', inner_width)
                .attr('height', inner_height)
                .attr('x', 0)
                .attr('y', 0)

            var chart = g.append('g')
                .attr('clip-path', 'url(#clip)');

            // Create stackData and stack bar chart

            
            var subgroups = Object.keys(data[1]).slice(1)
    
            var stackedData = d3.stack()
                                .keys(subgroups)(data)

            console.log(stackedData);
            var color = d3.scaleOrdinal()
                            .domain(subgroups)
                            .range(["#EC9A29", "#821214", '#106184'])
            chart.append('g')
                .selectAll('g')
                .data(stackedData)
                .join('g')
                .attr('fill', function(d) { return color(d.key); })
                .selectAll('rect')
                .data(function(d) { 
                    return d; 
                })
                .join('rect')
                .attr('x', function(d) {
                    return xscale(d.data.id)
                })
                .attr('y', function(d) {
                    return yscale(d[1]);
                })
                .attr('width', xscale.bandwidth())
                .attr('height', function(d) {
                    return yscale(d[0]) - yscale(d[1])
                })
                console.log(stackedData);

                let text = g.append("g");
                  text.selectAll('g')
                    .data(stackedData)
                    .join('g')
                    .selectAll('text')
                    .data(function(d){
                        return d;
                    })
                    .join('text')
                    .attr('class', 'textStackedBarChart')
                    .filter(function(d) { return (d[1] - d[0]) >0 })
                    .attr("y", function(d) { return yscale((d[0] + d[1]) / 2);})
                    .attr("x", function(d) { return xscale(d.data.id)})
                    .style("fill",'#000')
                    .text(function(d) { return (d[1] - d[0]).toFixed(2); });
 

            // // Create legend 
            let legend = g.append("g")
                .attr("transform", "translate(170, 310)")
                .attr("class", "legend")
                .style('width', '500px')

            var keys = ["1st Ticket Price", "2nd Ticket Price", "3rd Ticket Price"];
            var colors = ["#EC9A29", "#821214", "#106184"];

            var color = d3.scaleOrdinal()
                .domain(keys)
                .range(colors);

            var squareSize = 10;
            legend.selectAll('rect')
                .data(keys)
                .join('rect')
                .attr('x', (d, i) => 50 + (i * (squareSize + 130)))
                .attr('y', 130)
                .attr('width', squareSize)
                .attr('height', squareSize)
                .style('fill', function (d) {
                    return color(d)
                })

            legend.selectAll("text")
                .data(keys)
                .join('text')
                .attr("x", (d, i) => 75 + (i * (squareSize + 130)))
                .attr("y", 140)
                .attr("class", "textChart")
                .style("fill", function (d) {
                    return color(d)
                })
                .text(function (d) {
                    return d
                })

            // // Zoom event
            var zoom = d3.zoom()
                .extent([[0, 0], [inner_width, inner_height]])
                .scaleExtent([0.5, 5])
                .on("zoom", zoomed);

            svg.call(zoom);

            function zoomed(event) {
                // var newXscale = event.transform.rescaleX(xscale);
                var newYscale = event.transform.rescaleY(yscale);

                createXasis.call(d3.axisBottom(xscale));
                createYaxis.call(d3.axisLeft(newYscale));


                chart.selectAll('rect')
                .attr('x', function(d) {
                    return xscale(d.data.id)
                })
                .attr('y', function(d) {
                    return newYscale(d[1]);
                })
                .attr('width', xscale.bandwidth())
                .attr('height', function(d) {
                    return newYscale(d[0]) - newYscale(d[1])
                })

                g.selectAll('.textStackedBarChart')
                .attr('y', function(d) { return newYscale((d[0] + d[1]) / 2);})

            }


        })
        // -------------------------------------------------------------------------
        // -------------------------------------------------------------------------
        // Page Script
        document.addEventListener("DOMContentLoaded", () => {
            let sidebarButton = document.querySelector('#sidebarCollapse'),
                sidebar = document.querySelector('#sidebar'),
                mainSpace = document.querySelector('#v-pills-tabContent');

            sidebarButton.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                mainSpace.classList.contains('col-md-10') ?
                    mainSpace.classList.replace('col-md-10', 'col-12') && sidebar.classList.toggle('hidden') :
                    mainSpace.classList.replace('col-12', 'col-md-10') && sidebar.classList.toggle('hidden');
            });
        });




        window.onload = switchCharts('Checkin service');
        window.onload = tableToggle();


        var width = 400,
            height = 400,
            radius = Math.min(width, height) / 2;

        d3.csv("./data/customer_satisfaction.csv").then(function (data) {
            var data = data.filter(function (d) { return d["Customer Type"] == "Loyal Customer" });
            var data = [data.length, 100 - data.length];

            var color = d3.scaleOrdinal()
                .domain(data)
                .range(["#d73038", "#477CB2"]);

            var arc = d3.arc()
                .outerRadius(radius - 95)
                .innerRadius(radius - 80);

            var pie = d3.pie()
                .sort(null)
                .value(function (d) { return d });

            var svg = d3.select("#chart7").append("svg")
                .attr('viewBox', '0 0 400 400')
                // .attr("width", width)
                // .attr("height", height)
                .append("g")
                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

            svg.append("circle")
                .attr("cx", -70)
                .attr("cy", -5)
                .attr("r", 10)
                .attr("class", "total-header");

            svg.append("text")
                .attr("x", -55)
                .attr("y", 0)
                .attr("class", "naming")
                .text(`Loyal customers`);

            svg.append("text")
                .attr("x", -20)
                .attr("y", 25)
                .attr("class", "naming")
                .text(`${data[0]}%`);

            var g = svg.selectAll(".arc")
                .data(pie(data))
                .enter().append("g")
                .attr("class", "arc");

            g.append("path")
                .attr("d", arc)
                .style("fill", function (d, i) { return color(d.data); });

        });
        d3.csv("./data/customer_satisfaction.csv").then(function (data) {
            var distance = data.reduce((a, b) => a + +b.Flight_Distance, 0);
            var svg = d3.select("#chart8").append("svg")
                .attr('viewBox', '0 0 400 400')
                // .attr("width", width)
                // .attr("height", height)
                .append("g")
                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

            svg.append("text")
                .attr("x", -115)
                .attr("y", -60)
                .attr("class", "total-header")
                .text(`Our Total Flight Distance...`);

            svg.append("text")
                .attr("x", -20)
                .attr("y", -15)
                .attr("class", "total")
                .text(`${distance} km`);

            svg.append("text")
                .attr("x", -45)
                .attr("y", 20)
                .attr("class", "total-bold")
                .text(`${(distance / 1.64).toFixed(2)} miles`);

            svg.append("text")
                .attr("x", -22)
                .attr("y", 55)
                .attr("class", "total")
                .text(`${(distance / 40074).toFixed(1)} equators`);
        });
        d3.csv("./data/customer_satisfaction.csv").then(function (data) {
            var noDelays = data.filter(d => d['Arrival Delay in Minutes'] == 0 && d['Departure Delay in Minutes'] == 0).length;
            var data = [noDelays, data.length - noDelays];

            var color = d3.scaleOrdinal()
                .domain(data)
                .range(["#d73038", "#477CB2"]);

            var arc = d3.arc()
                .outerRadius(radius - 95)
                .innerRadius(radius - 80);

            var pie = d3.pie()
                .sort(null)
                .value(function (d) { return d });

            var svg = d3.select("#chart9").append("svg")
                .attr('viewBox', '0 0 400 400')
                // .attr("width", width)
                // .attr("height", height)
                .append("g")
                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

            svg.append("text")
                .attr("x", -78)
                .attr("y", 0)
                .attr("class", "naming")
                .text(`Flight with no delays`);

            svg.append("circle")
                .attr("cx", -90)
                .attr("cy", -5)
                .attr("r", 10)
                .attr("class", "total-header");

            svg.append("text")
                .attr("x", -20)
                .attr("y", 25)
                .attr("class", "naming")
                .text(`${noDelays}%`);

            var g = svg.selectAll(".arc")
                .data(pie(data))
                .enter().append("g")
                .attr("class", "arc");

            g.append("path")
                .attr("d", arc)
                .style("fill", function (d, i) { return color(d.data); });

        });


    </script>
</body>

</html>